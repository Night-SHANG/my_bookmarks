<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>网址导航</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Noto Sans SC',system-ui,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(-45deg,#667eea,#764ba2,#23a6d5,#23d5ab,#ff7e5f,#feb47b,#86a8e7,#91eae4);background-size:400% 400%;animation:gradientBG 20s linear infinite;min-height:100vh;padding:20px}
        @keyframes gradientBG{0%{background-position:0% 50%}25%{background-position:100% 50%}50%{background-position:100% 100%}75%{background-position:0% 100%}100%{background-position:0% 50%}}
        .container{max-width:1400px;margin:0 auto}
        header{color:#fff;margin-bottom:24px; padding: 0 10px;}
        .header-top{display:flex; justify-content:space-between; align-items:center; width:100%;}
        .header-left{flex:1;}
        .header-content{flex:1; display:flex; justify-content:center; align-items:center; text-align:center;}
        h1{font-size:2.5rem;margin:8px 0; display:inline-block;}
        .header-controls{flex:1; display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
        .subtitle{opacity:.9;font-size:1.1rem}

        .top-row{display:flex;flex-direction:column;gap:16px;align-items:center;justify-content:center;margin-bottom:20px;flex-wrap:wrap;width:100%}
        .search-and-controls{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%}
        .search-container{max-width:700px;flex:1;min-width:280px;position:relative;width:100%;max-width:700px}
        .search-box{width:100%;padding:14px 50px 14px 22px;border-radius:32px;border:1px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.2);color:#fff;outline:none;font-size:1rem}
        .search-box::placeholder{color:rgba(255,255,255,0.8)}
        .search-button{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:linear-gradient(45deg,#764ba2,#667eea);border:none;border-radius:50%;width:44px;height:44px;color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.1rem}

        .header-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
        .btn{background:rgba(255,255,255,0.18);border:1px solid rgba(255,255,255,0.25);padding:10px 16px;border-radius:12px;color:#fff;cursor:pointer;font-size:0.95rem;transition:all 0.2s ease;min-width:80px;text-align:center}
        .btn:hover{background:rgba(255,255,255,0.25);transform:translateY(-2px)}
        .btn.primary{background:linear-gradient(45deg,#764ba2,#667eea);font-weight:600}
        .engine-selector{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
        .engine-btn{background:rgba(255,255,255,0.12);padding:8px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.18);color:#fff;cursor:pointer;font-size:0.9rem;transition:all 0.2s ease}
        .engine-btn:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
        .engine-btn.active{background:rgba(255,255,255,0.38);transform:scale(1.05);font-weight:600}

        .category-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:center;justify-content:center}
        .cat-chip{background:rgba(255,255,255,0.18);padding:10px 16px;text-align:center;border-radius:999px;color:#fff;cursor:pointer;border:1px solid rgba(255,255,255,0.12);transition:all 0.2s ease;font-size:0.95rem;display:inline-flex;align-items:center;justify-content:center;box-sizing:border-box;height:38px;min-width:70px}
        .cat-chip:hover{background:rgba(255,255,255,0.25);transform:translateY(-1px)}
        .cat-chip.active{background:rgba(255,255,255,0.45);font-weight:600}

        .bookmarks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;padding:10px;max-width:1200px;margin:0 auto;justify-content:start;align-content:start;}
        .bookmark-card{background:rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius:14px;padding:14px 14px 14px 14px;display:flex;gap:12px;align-items:center;text-decoration:none;color:inherit;box-shadow:0 8px 32px rgba(0, 0, 0, 0.1);position:relative;overflow:visible;transition:all 0.3s ease;min-height:100px;height:100px;border:1px solid rgba(255, 255, 255, 0.2); min-width:220px; flex:1; margin:0 10px; flex-shrink:0;}
        .bookmark-card:hover{transform:translateY(-6px);box-shadow:0 12px 40px rgba(0, 0, 0, 0.15);background:rgba(255, 255, 255, 0.25);}
        .favicon{width:48px;height:48px;border-radius:10px;flex:0 0 48px;display:inline-flex;align-items:center;justify-content:center;background:rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); font-size:1.3rem}
        .favicon img{width:34px;height:34px;object-fit:contain}
        .meta{flex:1;min-width:0; display:flex; flex-direction:column; justify-content:center; height:58px;}
        .title{font-weight:600;color:#f0f0f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:1.05rem;max-width: calc(100% - 80px);}
        .url{font-size:0.88rem;color:#d0d0d0;word-break:break-all;margin-top:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .desc{font-size:0.85rem;color:#b0b0b0;margin-top:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-height: 1.2em; line-height: 1.2;}

        .card-actions{position:absolute;right:10px;top:10px;display:flex;gap:6px}
        .action-btn{background:rgba(0,0,0,0.08);border-radius:6px;padding:7px;font-size:0.9rem;border:none;cursor:pointer;color:#fff;transition:all 0.2s ease;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
        .action-btn:hover{background:rgba(0,0,0,0.15);color:#fff}

        /* modal */
        .modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
        .modal.show{display:flex}
        .modal-card{background:#fff;border-radius:16px;padding:24px;max-width:760px;width:100%;box-shadow:0 16px 50px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto}
        .form-row{display:flex;gap:12px;margin-bottom:14px}
        .form-row .field{flex:1}
        label{display:block;font-size:0.9rem;margin-bottom:8px;color:#333;font-weight:500}
        input[type=text],textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:1rem;transition:border-color 0.3s}
        input[type=text]:focus,textarea:focus,select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 2px rgba(102, 126, 234, 0.2)}
        textarea{min-height:90px}

        .toolbar{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:12px}

        .import-file{display:none}

        /* 拖拽排序相关样式 */
        .bookmark-card.dragging {
            opacity: 0.5;
            transform: scale(0.98);
            z-index: 1000;
        }

        .bookmark-card.placeholder {
            background: rgba(255, 255, 255, 0.3);
            border: 2px dashed #fff;
            min-height: 70px;
            visibility: visible;
        }
        
        .cat-chip.dragging {
            opacity: 0.5;
            transform: scale(0.98);
            z-index: 1000;
        }

        .cat-chip.placeholder {
            background: rgba(255, 255, 255, 0.38);
            border: 2px dashed #fff;
            transform: scale(1.05);
            font-weight: 600;
        }

        /* 响应式设计优化 */
        @media (max-width: 1200px) {
            .bookmarks-grid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr));max-width:1000px;gap:14px}
            .container{max-width:95%}
        }

        @media (max-width: 900px) {
            .bookmarks-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));max-width:800px;gap:12px}
            .top-row{flex-direction:column;align-items:flex-start}
            .search-container{width:100%}
            .controls{width:100%;justify-content:center}
            .engine-selector{margin-top:10px}
            h1{font-size:2.2rem}
        }

        @media (max-width: 700px) {
            .bookmarks-grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr));max-width:600px;gap:10px}
            .bookmark-card{padding:12px;gap:10px; min-width:180px;}
            .favicon{width:42px;height:42px;flex:0 0 42px}
            .favicon img{width:28px;height:28px}
            .title{font-size:1rem}
            .url{font-size:0.8rem}
            .desc{font-size:0.8rem}
            body{padding:15px}
            h1{font-size:2rem}
            .subtitle{font-size:1rem}
            .search-box{padding:12px 46px 12px 20px}
            .search-button{width:40px;height:40px}
            .btn{padding:9px 14px;font-size:0.9rem}
            .engine-btn{padding:7px 12px;font-size:0.88rem}
            .cat-chip{padding:7px 12px;font-size:0.9rem}
            .form-row{flex-direction:column;gap:10px}
        }

        @media (max-width: 500px) {
            .bookmarks-grid{grid-template-columns:1fr;max-width:none;width:100%;}
            .controls{flex-direction:column;align-items:flex-start}
            .engine-selector{width:100%;justify-content:flex-start}
            .btn{width:100%;text-align:center}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-left"></div>
                <div class="header-content">
                    <h1><i class="fas fa-compass"></i> 网址导航</h1>
                </div>
                <div class="header-controls">
                    <button id="addBtn" class="btn primary"><i class="fas fa-plus"></i> 添加站点</button>
                    <button id="exportBtn" class="btn">导出数据</button>
                    <button class="btn" id="importBtn">
                        导入数据
                        <input id="importFile" class="import-file" type="file" accept="application/json">
                    </button>
                </div>
            </div>
        </header>

        <div class="top-row">
            <div class="search-and-controls">
                <div class="engine-selector" id="engineSelector">
                    <button class="engine-btn active" data-engine="baidu">百度</button>
                    <button class="engine-btn" data-engine="google">Google</button>
                    <button class="engine-btn" data-engine="bing">必应</button>
                </div>
                
                <div class="search-container">
                    <input id="searchInput" class="search-box" placeholder="搜索网站或输入要跳转的网址（回车直接打开）..." />
                    <button id="searchButton" class="search-button"><i class="fas fa-search"></i></button>
                </div>
            </div>
        </div>

        <div class="category-bar" id="categoryBar">
            <!-- category chips dynamically injected -->
        </div>

        <div class="bookmarks-grid" id="bookmarksGrid">
            <!-- bookmarks injected here -->
        </div>
    </div>

    <!-- modal for add/edit -->
    <div class="modal" id="modal">
        <div class="modal-card">
            <div class="toolbar">
                <strong id="modalTitle">添加站点</strong>
                <div>
                    <button id="modalSave" class="btn primary">保存</button>
                    <button id="modalCancel" class="btn primary">退出</button>
                </div>
            </div>
            <div class="form-row">
                <div class="field">
                    <label>网站标题</label>
                    <input id="siteTitle" type="text" placeholder="例如：Bilibili">
                </div>
                <div class="field">
                    <label>网站链接（需包含 http/https）</label>
                    <input id="siteUrl" type="text" placeholder="https://www.bilibili.com">
                </div>
            </div>
            <div class="form-row">
                <div class="field">
                    <label>分类（可输入新分类）</label>
                    <input id="siteCategory" type="text" placeholder="例如：社交 / 开发 / 游戏">
                </div>
                <div class="field">
                    <label>图标（可选，留空则自动抓取）</label>
                    <input id="siteIcon" type="text" placeholder="可以填 favicon URL 或留空自动抓取">
                </div>
            </div>
            <div class="form-row">
                <div class="field">
                    <label>描述（可选）</label>
                    <input id="siteDesc" type="text" placeholder="简短描述">
                </div>
            </div>
        </div>
    </div>

    <script>
        // ---------- Data & Storage ----------
        const STORAGE_KEY = 'my_nav_v2';
        const CATEGORY_ORDER_KEY = 'category_order';

        const DEFAULT_BOOKMARKS = [
            {id: genId(), title:'百度', url:'https://www.baidu.com/', desc:'搜索引擎', category:'全部', icon:'https://www.baidu.com/favicon.ico'}
        ];

        let bookmarks = load();
        let currentCategory = '全部';
        let currentEngine = 'baidu';

        // ---------- Utilities ----------
        function genId(){ return 'b_' + Math.random().toString(36).slice(2,9); }

        // 图标缓存
        const FAVICON_CACHE_KEY = 'favicon_cache_v1';
        let faviconCache = loadFaviconCache();

        function save(){ 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bookmarks)); 
        }
        function load(){ 
            try{ 
                const raw = localStorage.getItem(STORAGE_KEY); 
                if(!raw) return DEFAULT_BOOKMARKS.slice(); 
                return JSON.parse(raw); 
            }catch(e){
                console.error(e); 
                return DEFAULT_BOOKMARKS.slice(); 
            } 
        }
        
        function loadFaviconCache(){
            try{
                const raw = localStorage.getItem(FAVICON_CACHE_KEY);
                if(!raw) return {};
                return JSON.parse(raw);
            }catch(e){
                console.error('Error loading favicon cache:', e);
                return {};
            }
        }
        
        function saveFaviconCache(){
            try{
                localStorage.setItem(FAVICON_CACHE_KEY, JSON.stringify(faviconCache));
            }catch(e){
                console.error('Error saving favicon cache:', e);
            }
        }
        
        function setCachedFavicon(domain, url){
            faviconCache[domain] = { url, timestamp: Date.now() };
            saveFaviconCache();
        }
        
        function getCachedFavicon(domain){
            const cached = faviconCache[domain];
            if(cached){
                // 检查缓存是否过期（7天）
                if(Date.now() - cached.timestamp < 7 * 24 * 60 * 60 * 1000){
                    return cached.url;
                } else {
                    // 删除过期缓存
                    delete faviconCache[domain];
                    saveFaviconCache();
                }
            }
            return null;
        }

        // ---------- Favicon helper ----------
        // Strategy: try multiple services with fallbacks, add caching
        function faviconUrlsFor(url){
            try{ 
                const u = new URL(url); 
                const domain = u.hostname;
                
                // 检查是否有缓存的图标
                const cached = getCachedFavicon(domain);
                if(cached) {
                    return [cached]; // 如果有缓存，优先使用缓存的图标
                }
                
                const domainUrl = u.origin; 
                const paths = [
                    '/favicon.ico', // 标准favicon
                    '/favicon.png', // PNG格式favicon
                    '/favicon.svg', // SVG格式favicon
                    '/favicon.gif', // GIF格式favicon
                    '/apple-touch-icon.png', // 苹果触控图标
                    '/apple-touch-icon-precomposed.png', // 苹果预合成触控图标
                    '/apple-touch-icon-180x180.png', // 特定尺寸苹果触控图标
                    '/static/favicon.png', // 常见静态资源路径
                    '/static/favicon.ico',
                    '/static/icon.png',
                    '/static/icons/favicon.png',
                    '/assets/favicon.png', // 常见资源路径
                    '/assets/favicon.ico',
                    '/assets/icon.png',
                    '/assets/icons/favicon.png',
                    '/public/favicon.png', // 常见公开资源路径
                    '/public/favicon.ico',
                    '/public/icon.png',
                    '/public/icons/favicon.png',
                    '/img/favicon.png', // 常见图片路径
                    '/img/favicon.ico',
                    '/img/icon.png',
                    '/images/favicon.png',
                    '/images/favicon.ico',
                    '/images/icon.png'
                ];
                
                // 为特定域名添加特殊路径
                let specificUrls = [];
                if (domain.includes('alicdn.com')) {
                    specificUrls = [
                        'https://g.alicdn.com/sail-web/maas/2.9.86/favicon/128.ico',
                        'https://assets.alicdn.com/g/qwenweb/qwen-webui-fe/0.0.219/static/favicon.png',
                        'https://assets.alicdn.com/g/qwenweb/qwen-webui-fe/0.0.219/static/qwen_icon_move_light_180.png',
                        'https://assets.alicdn.com/g/qwenweb/qwen-webui-fe/0.0.219/favicon.png'
                    ];
                } else if (domain.includes('doubao.com')) {
                    specificUrls = [
                        'https://lf-flow-web-cdn.doubao.com/obj/flow-doubao/doubao/web/logo-icon.png'
                    ];
                }
                
                // 组合所有可能的URL
                let candidates = [];
                
                // 添加特定域名的URL（如果存在）
                candidates = candidates.concat(specificUrls);
                
                // 添加标准路径的URL
                paths.forEach(path => {
                    candidates.push(`${domainUrl.replace(/\/$/,'')}${path}`);
                });
                
                // 添加第三方服务作为最后的后备
                candidates.push(`https://icons.duckduckgo.com/ip3/${u.hostname}.ico`);
                
                return candidates; 
            }catch(e){ 
                return ['favicon.ico']; 
            }
        }

        // ---------- Rendering ----------
        const bookmarksGrid = document.getElementById('bookmarksGrid');
        const categoryBar = document.getElementById('categoryBar');
        const searchInput = document.getElementById('searchInput');

        function getCategories(){ 
            const set = new Set(bookmarks.map(b => b.category || '未分类')); 
            const defaultCategories = ['全部', ...Array.from(set).sort()]; 
            
            // 尝试从本地存储获取自定义分类顺序
            const storedOrder = JSON.parse(localStorage.getItem('category_order') || "[]");
            
            if (storedOrder.length === 0) {
                return defaultCategories;
            }
            
            // 过滤storedOrder，只保留当前仍存在于书签中的分类以及'全部'分类
            const currentCategories = new Set(defaultCategories);
            const validStoredCategories = storedOrder.filter(cat => currentCategories.has(cat));
            
            // 对于不在有效存储顺序中的默认分类，添加到末尾
            const remainingCategories = defaultCategories.filter(cat => !storedOrder.includes(cat));
            return [...validStoredCategories, ...remainingCategories];
        }

        function renderCategories(){ categoryBar.innerHTML = ''; const cats = getCategories(); cats.forEach(cat => {
            const chip = document.createElement('button'); chip.className = 'cat-chip' + (cat===currentCategory? ' active':''); chip.textContent = cat;
            chip.draggable = true; // 启用拖拽
            chip.addEventListener('click', ()=>{ currentCategory = cat; renderAll(); });
            
            // 添加拖拽事件监听器
            chip.addEventListener('dragstart', handleCategoryDragStart);
            chip.addEventListener('dragend', handleCategoryDragEnd);
            chip.addEventListener('dragover', handleCategoryDragOver);
            chip.addEventListener('dragenter', handleCategoryDragEnter);
            chip.addEventListener('dragleave', handleCategoryDragLeave);
            chip.addEventListener('drop', handleCategoryDrop);
            
            categoryBar.appendChild(chip);
        }); }

        function renderBookmarks(filterText=''){
            bookmarksGrid.innerHTML = '';
            const lower = filterText.toLowerCase();
            const list = bookmarks.filter(b => {
                if(currentCategory && currentCategory!=='全部' && (b.category||'未分类') !== currentCategory) return false;
                if(!lower) return true;
                return (b.title||'').toLowerCase().includes(lower) || (b.url||'').toLowerCase().includes(lower) || (b.desc||'').toLowerCase().includes(lower) || (b.category||'').toLowerCase().includes(lower);
            });

            if(list.length===0){ bookmarksGrid.innerHTML = '<p style="color:#fff">无匹配项</p>'; return; }

            list.forEach(b => {
                const a = document.createElement('a'); a.href = b.url; a.target='_blank'; a.className='bookmark-card';
                a.draggable = true; // 启用拖拽

                const fav = document.createElement('div'); fav.className='favicon';
                // 添加加载指示器
                fav.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;"><i class="fas fa-spinner fa-pulse" style="font-size:18px;color:rgba(102,126,234,0.6)"></i></div>';
                
                const img = document.createElement('img');
                img.style.display = 'none'; // 初始隐藏图片
                // set src chain
                const candidates = (b.icon && b.icon.trim()) ? [b.icon.trim()] : faviconUrlsFor(b.url);
                img.src = candidates[0];
                
                let idx = 0;
                
                img.onload = function(){
                    // 加载成功，替换加载指示器为图片
                    fav.innerHTML = '';
                    fav.appendChild(img);
                    img.style.display = 'block';
                    
                    // 如果使用的是候选URL（非用户自定义），则缓存该URL
                    if(!b.icon || !b.icon.trim()) {
                        try {
                            const urlObj = new URL(b.url);
                            const domain = urlObj.hostname;
                            // 检查加载的图标URL是否是候选URL之一
                            if(candidates.includes(img.src)) {
                                setCachedFavicon(domain, img.src);
                            }
                        } catch(e) {
                            console.error('Error caching favicon:', e);
                        }
                    }
                };
                img.onerror = function(){
                    idx++;
                    if(idx < candidates.length){
                        img.src = candidates[idx];
                    } else {
                        // 所有源都失败，使用默认图标
                        fav.innerHTML = '<i class="fas fa-globe" style="font-size:20px;color:#667eea"></i>';
                    }
                };
                // 不要立即添加图片，等待加载完成

                const meta = document.createElement('div'); meta.className='meta';
                const title = document.createElement('div'); title.className='title'; title.textContent = b.title || b.url;
                const url = document.createElement('div'); url.className='url'; url.textContent = b.url.replace(/^https?:\/\//,'');
                const desc = document.createElement('div'); desc.className='desc'; desc.textContent = b.desc || ('分类：' + (b.category||'未分类'));
                meta.appendChild(title); meta.appendChild(url); meta.appendChild(desc);

                const actions = document.createElement('div'); actions.className='card-actions';
                const editBtn = document.createElement('button'); editBtn.className='action-btn'; editBtn.title='编辑'; editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openModal('edit', b); });
                const delBtn = document.createElement('button'); delBtn.className='action-btn'; delBtn.title='删除'; delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                delBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); if(confirm('确认删除【'+b.title+'】？')){ bookmarks = bookmarks.filter(x=>x.id !== b.id); save(); renderAll(); } });
                actions.appendChild(editBtn); actions.appendChild(delBtn);

                // 添加拖拽事件监听器
                a.addEventListener('dragstart', handleDragStart);
                a.addEventListener('dragend', handleDragEnd);
                a.addEventListener('dragover', handleDragOver);
                a.addEventListener('dragenter', handleDragEnter);
                a.addEventListener('dragleave', handleDragLeave);
                a.addEventListener('drop', handleDrop);

                a.appendChild(fav); a.appendChild(meta); a.appendChild(actions);
                bookmarksGrid.appendChild(a);
            });
        }

        function renderAll(){ renderCategories(); renderBookmarks(searchInput.value.trim()); }

        // ---------- Search & Engine ----------
        const engines = { 'baidu': q=>`https://www.baidu.com/s?wd=${encodeURIComponent(q)}`, 'google': q=>`https://www.google.com/search?q=${encodeURIComponent(q)}`, 'bing': q=>`https://www.bing.com/search?q=${encodeURIComponent(q)}` };
        document.getElementById('searchButton').addEventListener('click', ()=>{ const q = searchInput.value.trim(); if(!q) return; openSearchOrUrl(q); });
        searchInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ const q = searchInput.value.trim(); if(!q) return; openSearchOrUrl(q); } else { setTimeout(()=>renderBookmarks(searchInput.value.trim()),0); } });

        function openSearchOrUrl(q){ // if q looks like a url -> open directly
            if(/^https?:\/\//i.test(q) || /^([\w-]+\.)+[\w-]+(\/.*)?$/.test(q) && q.includes('.')){
                const url = /^https?:\/\//i.test(q) ? q : 'https://' + q;
                window.open(url, '_blank');
            } else {
                const url = engines[currentEngine] ? engines[currentEngine](q) : engines.baidu(q);
                window.open(url,'_blank');
            }
        }

        // engine buttons
        document.querySelectorAll('.engine-btn').forEach(btn=>{ btn.addEventListener('click', ()=>{ document.querySelectorAll('.engine-btn').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); currentEngine = btn.dataset.engine; }); });

        // ---------- Modal add/edit ----------
        const modal = document.getElementById('modal'); const modalTitle = document.getElementById('modalTitle');
        const siteTitle = document.getElementById('siteTitle'); const siteUrl = document.getElementById('siteUrl'); const siteDesc = document.getElementById('siteDesc'); const siteCategory = document.getElementById('siteCategory'); const siteIcon = document.getElementById('siteIcon');
        let modalMode = 'add'; let editingId = null;

        document.getElementById('addBtn').addEventListener('click', ()=> openModal('add'));
        document.getElementById('modalCancel').addEventListener('click', closeModal);
        document.getElementById('modalSave').addEventListener('click', ()=>{
            const title = siteTitle.value.trim(); const url = siteUrl.value.trim(); const desc = siteDesc.value.trim(); const cat = siteCategory.value.trim() || '未分类'; const icon = siteIcon.value.trim();
            if(!title || !url){ alert('请填写标题和链接'); return; }
            try{ new URL(url); }catch(e){ if(!/^https?:\/\//i.test(url)) { if(confirm('链接似乎没有协议，是否自动补全 https:// 并保存？')){ saveEntry({id: modalMode==='edit'? editingId : genId(), title, url: (url.startsWith('http')? url: 'https://' + url), desc, category:cat, icon}); closeModal(); return; } else return; } }
            saveEntry({id: modalMode==='edit'? editingId : genId(), title, url, desc, category:cat, icon}); closeModal();
        });

        function openModal(mode, entry){ modalMode = mode; modal.classList.add('show'); if(mode==='add'){ modalTitle.textContent='添加站点'; siteTitle.value=''; siteUrl.value=''; siteDesc.value=''; siteCategory.value=''; siteIcon.value=''; editingId=null; } else { modalTitle.textContent='编辑站点'; siteTitle.value=entry.title||''; siteUrl.value=entry.url||''; siteDesc.value=entry.desc||''; siteCategory.value=entry.category||''; siteIcon.value=entry.icon||''; editingId=entry.id; } }
        function closeModal(){ modal.classList.remove('show'); }

        function saveEntry(obj){ const exists = bookmarks.find(b=>b.id===obj.id); if(exists){ Object.assign(exists, obj); } else { bookmarks.push(obj); } save(); renderAll(); }

        // ---------- Drag and Drop ----------
        let draggedElement = null;
        let draggedCategory = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            draggedElement = null;
            // 移除所有占位符
            document.querySelectorAll('.bookmark-card.placeholder').forEach(placeholder => {
                placeholder.classList.remove('placeholder');
            });
        }

        function handleDragOver(e) {
            e.preventDefault(); // 必须调用才能允许放置
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter() {
            // 只有当不是被拖动的元素时才添加占位符类
            if (this !== draggedElement) {
                this.classList.add('placeholder');
            }
        }

        function handleDragLeave() {
            this.classList.remove('placeholder');
        }

        function handleDrop(e) {
            e.stopPropagation(); // 阻止事件冒泡
            if (this !== draggedElement) {
                // 获取所有当前显示的书签卡片（不包括搜索过滤掉的）
                const visibleBookmarks = Array.from(bookmarksGrid.querySelectorAll('.bookmark-card:not(.placeholder)'));
                const draggedIndex = visibleBookmarks.indexOf(draggedElement);
                const targetIndex = visibleBookmarks.indexOf(this);

                // 交换两个书签在数组中的位置
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    const draggedBookmark = bookmarks.find(b => b.id === getBookmarkIdFromElement(draggedElement));
                    const targetBookmark = bookmarks.find(b => b.id === getBookmarkIdFromElement(this));

                    // 更新数组顺序
                    const newBookmarks = [...bookmarks];
                    const draggedPos = newBookmarks.findIndex(b => b.id === draggedBookmark.id);
                    const targetPos = newBookmarks.findIndex(b => b.id === targetBookmark.id);

                    // 交换位置
                    [newBookmarks[draggedPos], newBookmarks[targetPos]] = [newBookmarks[targetPos], newBookmarks[draggedPos]];
                    bookmarks = newBookmarks;
                    
                    // 保存新顺序到本地存储
                    save();

                    // 重新渲染
                    renderAll();
                }
            }
            return false;
        }

        // 处理分类标签的拖拽事件
        function handleCategoryDragStart(e) {
            draggedCategory = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.textContent);
        }

        function handleCategoryDragEnd() {
            this.classList.remove('dragging');
            draggedCategory = null;
            // 移除所有占位符
            document.querySelectorAll('.cat-chip.placeholder').forEach(placeholder => {
                placeholder.classList.remove('placeholder');
            });
        }

        function handleCategoryDragOver(e) {
            e.preventDefault(); // 必须调用才能允许放置
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleCategoryDragEnter(e) {
            // 只有当不是被拖动的元素时才添加占位符类
            if (this !== draggedCategory) {
                this.classList.add('placeholder');
            }
        }

        function handleCategoryDragLeave(e) {
            this.classList.remove('placeholder');
        }

        function handleCategoryDrop(e) {
            e.stopPropagation(); // 阻止事件冒泡
            if (this !== draggedCategory) {
                // 获取所有分类标签（不包括占位符）
                const categoryElements = Array.from(categoryBar.querySelectorAll('.cat-chip:not(.placeholder)'));
                const draggedCategoryName = draggedCategory.textContent;
                const targetCategoryName = this.textContent;

                // 获取当前分类顺序
                const categories = getCategories();
                
                // 找到拖拽和目标分类的索引
                const draggedIndex = categories.indexOf(draggedCategoryName);
                const targetIndex = categories.indexOf(targetCategoryName);

                if (draggedIndex !== -1 && targetIndex !== -1) {
                    // 创建新顺序数组
                    const newCategories = [...categories];
                    
                    // 从原位置移除拖拽的分类
                    const [movedCategory] = newCategories.splice(draggedIndex, 1);
                    
                    // 计算新位置（如果目标位置在拖拽元素之前，需要调整索引）
                    const newIndex = targetIndex > draggedIndex ? targetIndex : targetIndex;
                    
                    // 插入到新位置
                    newCategories.splice(newIndex, 0, movedCategory);
                    
                    // 保存新的分类顺序到本地存储
                    localStorage.setItem(CATEGORY_ORDER_KEY, JSON.stringify(newCategories));
                    
                    // 重新渲染分类
                    renderAll();
                }
            }
            return false;
        }

        // 从DOM元素中提取书签ID的辅助函数
        function getBookmarkIdFromElement(element) {
            // 查找书签URL以匹配数据中的书签
            const url = element.href;
            if (url) {
                const bookmark = bookmarks.find(b => b.url === url);
                return bookmark ? bookmark.id : null;
            }
            return null;
        }

        // ---------- import/export/reset ----------
        document.getElementById('exportBtn').addEventListener('click', ()=>{
            const dataStr = JSON.stringify(bookmarks, null, 2);
            const blob = new Blob([dataStr], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'bookmarks.json'; a.click(); URL.revokeObjectURL(url);
        });

        const importFile = document.getElementById('importFile'); 
        document.getElementById('importBtn').addEventListener('click', () => {
            importFile.click();
        });
        importFile.addEventListener('change', (e)=>{
            const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = () => {
                try{ const data = JSON.parse(reader.result); if(Array.isArray(data)){ bookmarks = data; save(); renderAll(); alert('导入成功'); } else { alert('导入文件格式不正确，需为 bookmarks 数组'); } }catch(err){ alert('JSON 解析错误'); }
            }; reader.readAsText(f);
        });

        // ---------- init ----------
        // 初始化分类顺序存储
        if (!localStorage.getItem(CATEGORY_ORDER_KEY)) {
            // 如果没有存储的分类顺序，初始化为默认顺序
            const initialCategories = getCategories();
            localStorage.setItem(CATEGORY_ORDER_KEY, JSON.stringify(initialCategories));
        }
        
        renderAll();

        // accessibility: focus search
        searchInput.focus();

        // expose for debugging
        window.myNav = {bookmarks, save, load, getCategories};
    </script>
</body>
</html>
